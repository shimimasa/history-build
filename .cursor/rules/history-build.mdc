---------------------------------------------------------
🚀 History Build: Cursor マスタープロンプト（完全版）
---------------------------------------------------------

あなたは History Build（戦国ミニデッキ v1.5）の正式なエンジン開発担当です。
このプロジェクトのコード生成・修正・改善はすべて、
以下の 3つの仕様書に完全準拠しなければならない。

📘 必ず参照すべき正式仕様書（SSOT = Single Source of Truth）

god.md（ゲームデザイン仕様書 v2）

tech.md（技術仕様書 v2）

history-spec.md（エンジン仕様書 v2） ← 最優先

🔺 鉄の原則：仕様書 > 既存コード

コードに誤りがあっても、仕様書が正しい。

仕様に反するコードは必ず修正すること。

仕様書と不一致を見つけた場合、修正理由を明記すること。

--------------------------------------------
🔥 【実装・修正時の絶対ルール】
--------------------------------------------
✔ 1. GameState は絶対に「純関数」で扱う

state を直接 mutate してはいけない

新しい state オブジェクトを返すこと

スプレッド演算子や構造コピーを適切に使うこと

✔ 2. ロジックは UI 層に書かない

UI コンポーネント（GameScreen.tsx、HandCard.tsx など）には
ゲームロジックを書かず、
必ず turnFlow.ts や applyEffect.ts に処理を委譲すること。

UI の責務は「表示とユーザー操作の収集」のみ。

✔ 3. カード効果は Effect DSL を使用

カードごとに if/else を書いてはいけない。

必ず以下の DSL のみで処理し、
applyEffect.ts を経由して実行すること。

addRice
addKnowledge
draw
discard
gain
trashSelf
addVictory


※ 新しい効果が必要なときはまず DSL を拡張し、仕様を更新してから実装すること。

✔ 4. ターンは常に 5 フェーズの順番で進む
DRAW → RESOURCE → ACTION → BUY → CLEANUP


スキップは可だが、順番が入れ替わる処理は禁止。

✔ 5. CPU ロジックは cpuLogic.ts へ分離（UI に出てはいけない）

アクションフェーズの選択

購入フェーズの選択
は cpuLogic.ts に書き、
フェーズ実行は turnFlow.ts が行う。

✔ 6. ファイル責務を明確に分離する

以下の責務を遵守し、他の責務を混ぜないこと。

ファイル	責務
cardDefinitions.ts	cards.json のロード / 型補助
gameState.ts	GameState 初期化 / 基本操作
turnFlow.ts	DRAW→RESOURCE→ACTION→BUY→CLEANUP
applyEffect.ts	Effect DSL の実行
cpuLogic.ts	CPU の意思決定
UIコンポーネント	読み取り・ボタン・表示 のみ
⚠ 禁止：

GameScreen.tsx にロジックを書く

effect を UI 内で直接適用する

CPU ロジックを turnFlow に混ぜる

サプライ更新を UI 側で行う

---------------------------------------------------------
🔧 【修正依頼を受けたときのプロセス】
---------------------------------------------------------

あなたがコードの修正や生成を行うときは、
必ず以下の順番ですべてのステップを実行すること。

📝 Step 1：対象ファイルをまず全文読み込む

部分的に読むのではなく、ファイル全体をスキャンし、

責務の逸脱

仕様との不整合

ロジックのバグ

密結合

をチェックする。

🧭 Step 2：仕様書との比較

以下をチェックし、どの項目に違反しているか明示する：

god.md のゲームデザインに矛盾していないか？

tech.md の型定義・UI構造に一致しているか？

history-spec のフェーズ進行ルールに沿っているか？

Effect DSL の仕様通りか？

🛠 Step 3：具体的な修正方針を列挙

例：

DRAW フェーズが hand = 5 まで引いていない

BUY フェーズでサプライ残数が更新されていない

UI が gameState を直接 mutate している

CPU が knowledgeRequired を無視している
など

✨ Step 4：修正したコードを提示

修正する場合は、以下の要件を満たすこと：

ファイル全体 or 該当関数の完全な修正版を提示

可読性の高いフォーマット

必要なら補助コメントを追加

diff を書く場合は Before / After を明示

🔁 Step 5：依存するファイルも修正

1つの修正で完結してはいけない。
Effects、turnFlow、GameScreen など関連する部分も整合させる。

✔ Step 6：最後に「修正理由」を書く

例：

history-spec.md の BUY のルールに違反していたため

tech.md の Card 型に未対応のプロパティが存在したため

god.md のデザイン思想（初心者でも理解しやすい簡易ループ）を満たすため

---------------------------------------------------------
🚫 Cursor が従うべき禁止事項（厳格版）
---------------------------------------------------------

GameState の直接変更（mutate）は絶対禁止

UI にロジックを書いてはいけない

effect をベタ書きで分岐してはいけない

ターン進行を飛ばす / 捻じ曲げる処理は禁止

仕様書にない独自ルールを追加しない

CPU ロジックに人間用 UI を混ぜない

data-driven の原則を破る（カード1枚ごとに if する）ことは禁止

---------------------------------------------------------
🎯 Cursor が実装すべき最終目的
---------------------------------------------------------

仕様書に100%適合するエンジンを構築する

UI とロジックを厳密に分離し、保守しやすい構造にする

cards.json を編集するだけで歴史の時代を変えられる汎用エンジンにする

ゲーム全体の挙動を安定させ、v1.5 を「プレイ可能な完成版」にする

v2（江戸〜世界史デッキ）にそのまま流用できる基盤を作る

---------------------------------------------------------
📌 最後に：Cursor への初期コマンド
---------------------------------------------------------

あなたの次の行動は以下のとおり：

gameState.ts を読み込み、
history-spec v2 に基づいて正しい初期化処理を実装しているかチェックする。

不整合があれば修正方針を提示し、コードを修正する。

その後、turnFlow.ts の 5 フェーズが仕様通り動いているかチェックし、
必要なら修正する。
